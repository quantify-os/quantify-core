ARG ROOT_IMAGE=python:latest
FROM $ROOT_IMAGE

LABEL maintainer="Quantify Consortium"
ENV LANG=C.UTF-8 LC_ALL=C.UTF-8
ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/Amsterdam
# only necessary for unix that runs with headless display
ENV MPLBACKEND=agg

RUN apt-get update -q && \
    apt-get install -q -y --no-install-recommends --fix-missing \
        rsync \
        xauth \
        xvfb \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# This wheel package is normally generated by CI. Locally you may generate it calling
# $ python setup.py bdist_wheel
COPY dist/quantify_core-*.whl /root/wheel/
RUN pip install --upgrade --upgrade-strategy eager \
    pip \
    setuptools \
    twine \
    && find /root/wheel -name quantify_core-*-py3-none-any.whl -exec pip install {}[dev] \; \
    # It must always be installed in before_script, because wheel package may be updated later
    && pip uninstall -y quantify-core \
    && pip freeze --all > /frozen-requirements.txt

RUN if [ ! -d ~/.ipython/profile_default ]; then mkdir -p ~/.ipython/profile_default; fi && \
    echo "c.InteractiveShellApp.matplotlib = 'inline'" >> ~/.ipython/profile_default/ipython_config.py
